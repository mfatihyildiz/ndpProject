<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Add Appointment</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">
    <h1>New Appointment</h1>
    <nav>
        <a th:href="@{/appointments}">Back to Appointments</a>
    </nav>
    <form th:action="@{/appointments/save}" method="post">
        <label>Customer:</label>
        <div th:if="${isCustomer}">
            <input type="hidden" name="customerId" th:value="${selectedCustomerId}">
            <p style="padding: 8px; background-color: #e9ecef; border-radius: 4px; display: inline-block;">
                <strong th:text="${customers[0].fullName}"></strong> (You)
            </p>
        </div>
        <select th:if="${!isCustomer}" name="customerId" required>
            <option value="">-- Select Customer --</option>
            <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.fullName}"></option>
        </select>
        <br>

        <label>Salon:</label>
        <select id="salonSelect" name="salonId" required>
            <option value="">-- Select Salon --</option>
            <option th:each="salon : ${salons}" th:value="${salon.id}" th:text="${salon.name}"></option>
        </select><br>

        <label>Employee:</label>
        <select name="employeeId" id="employeeSelect" required disabled>
            <option value="">-- Select Employee --</option>
            <option th:each="e : ${employees}"
                    th:value="${e.id}"
                    th:text="${e.fullName + ' (' + e.specialization + ')'}"
                    th:attr="data-salon=${e.salon != null ? e.salon.id : ''},
                         data-skills=${#strings.listJoin(e.skills.?[true].![id], ',')},
                         data-availability=${employeeAvailability[e.id]}"></option>
        </select>
        <p><small>Pick a salon first to see available employees.</small></p>
        <br>
        <label>Service:</label>
        <select name="serviceId" id="serviceSelect" required disabled onchange="updateServiceDetails(); updateAvailableSlots();">
            <option value="">-- Select Service --</option>
            <option th:each="s : ${services}"
                    th:value="${s.id}"
                    th:text="${s.name}"
                    th:attr="data-salon=${s.salon != null ? s.salon.id : ''},
                         data-duration=${s.duration},
                         data-price=${s.price}"></option>
        </select><br>

        <div id="serviceDetails" style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; background-color: #f9f9f9; border-radius: 4px; display: none;">
            <strong>Service Details:</strong>
            <p id="serviceDetailsText" style="margin: 5px 0;"></p>
        </div>


        <div id="availabilityInfo" style="border:1px solid #ccc;padding:10px;margin-bottom:15px;">
            <strong>Available Time Slots:</strong>
            <p id="availabilityText">Select an employee, service, and date to see available time slots.</p>
            <div id="availableSlotsList" style="margin-top: 10px;"></div>
        </div>

        <label>Date:</label>
        <input type="date" id="appointmentDate" name="appointmentDate" required onchange="updateAvailableSlots()"><br>

        <label>Time:</label>
        <select id="appointmentTime" name="appointmentTime" required disabled>
            <option value="">-- Select a time slot --</option>
        </select>
        <input type="hidden" id="dateTime" name="dateTime" required><br>

        <button type="submit">Save Appointment</button>
    </form>
</div>

<script>
    const salonSelect = document.getElementById('salonSelect');
    const employeeSelect = document.getElementById('employeeSelect');
    const serviceSelect = document.getElementById('serviceSelect');
    const availabilityText = document.getElementById('availabilityText');

    function filterEmployeesBySalon() {
        const selectedSalon = salonSelect.value;
        const options = Array.from(employeeSelect.options);
        let firstVisible = null;

        if (!selectedSalon) {
            options.forEach(option => option.hidden = option.value !== '');
            employeeSelect.value = '';
            employeeSelect.disabled = true;
            serviceSelect.value = '';
            serviceSelect.disabled = true;
            updateAvailabilityMessage();
            return;
        }

        options.forEach(option => {
            if (!option.value) {
                option.hidden = false;
                return;
            }
            const employeeSalon = option.dataset.salon || '';
            option.hidden = selectedSalon && employeeSalon !== selectedSalon;
            if (!option.hidden && !firstVisible) {
                firstVisible = option;
            }
        });

        employeeSelect.value = firstVisible ? firstVisible.value : '';
        employeeSelect.disabled = !firstVisible;
        filterServicesByEmployee();
        updateAvailabilityMessage();
    }

    function filterServicesByEmployee() {
        const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            Array.from(serviceSelect.options).forEach(option => option.hidden = option.value !== '');
            serviceSelect.value = '';
            serviceSelect.disabled = true;
            return;
        }

        const skillIds = selectedOption && selectedOption.dataset.skills
            ? selectedOption.dataset.skills.split(',').filter(Boolean)
            : [];
        const employeeSalon = selectedOption && selectedOption.dataset.salon ? selectedOption.dataset.salon : '';

        const options = Array.from(serviceSelect.options);
        let firstVisible = null;

        options.forEach(option => {
            if (!option.value) {
                option.hidden = false;
                return;
            }
            const serviceSalon = option.dataset.salon || '';
            const lacksSkill = skillIds.length > 0 && !skillIds.includes(option.value);
            const wrongSalon = employeeSalon && serviceSalon && employeeSalon !== serviceSalon;
            option.hidden = lacksSkill || wrongSalon;
            if (!option.hidden && !firstVisible) {
                firstVisible = option;
            }
        });

        serviceSelect.value = firstVisible ? firstVisible.value : '';
        serviceSelect.disabled = !firstVisible;
        updateServiceDetails();
    }

    function updateAvailabilityMessage() {
        updateAvailableSlots();
    }

    function updateServiceDetails() {
        const serviceSelect = document.getElementById('serviceSelect');
        const serviceDetails = document.getElementById('serviceDetails');
        const serviceDetailsText = document.getElementById('serviceDetailsText');
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

        if (!selectedOption || !selectedOption.value) {
            serviceDetails.style.display = 'none';
            return;
        }

        const serviceName = selectedOption.textContent;
        const duration = selectedOption.dataset.duration || 'N/A';
        const price = selectedOption.dataset.price || '0.00';

        serviceDetailsText.innerHTML = `
            <strong>${serviceName}</strong><br>
            Duration: ${duration} minutes<br>
            Price: $${parseFloat(price).toFixed(2)}
        `;
        serviceDetails.style.display = 'block';
    }

    function updateAvailableSlots() {
        const selectedEmployee = employeeSelect.value;
        const selectedService = serviceSelect.value;
        const selectedDate = document.getElementById('appointmentDate').value;
        const timeSelect = document.getElementById('appointmentTime');
        const slotsList = document.getElementById('availableSlotsList');

        timeSelect.innerHTML = '<option value="">-- Select a time slot --</option>';
        timeSelect.disabled = true;
        slotsList.innerHTML = '';

        if (!selectedEmployee || !selectedService || !selectedDate) {
            availabilityText.textContent = 'Select an employee, service, and date to see available time slots.';
            return;
        }

        const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];
        const serviceDuration = serviceOption ? (serviceOption.dataset.duration || 30) : 30;

        fetch(`/appointments/available-slots?employeeId=${selectedEmployee}&date=${selectedDate}&serviceDuration=${serviceDuration}`)
            .then(response => response.json())
            .then(slots => {
                if (slots.length === 0) {
                    availabilityText.textContent = 'No available time slots for this date. The employee may be closed or fully booked.';
                    slotsList.innerHTML = '<p style="color: #999; font-style: italic;">No slots available</p>';
                    return;
                }

                availabilityText.textContent = `Found ${slots.length} available time slot(s):`;

                slots.forEach(slot => {
                    const dateTime = new Date(slot);
                    const timeStr = dateTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = timeStr;
                    timeSelect.appendChild(option);
                });

                timeSelect.disabled = false;

                timeSelect.addEventListener('change', function() {
                    if (this.value) {
                        document.getElementById('dateTime').value = this.value;
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching available slots:', error);
                availabilityText.textContent = 'Error loading available slots. Please try again.';
            });
    }

    salonSelect.addEventListener('change', filterEmployeesBySalon);
    employeeSelect.addEventListener('change', () => {
        filterServicesByEmployee();
        updateAvailableSlots();
    });

    filterEmployeesBySalon();
</script>
</body>
</html>
